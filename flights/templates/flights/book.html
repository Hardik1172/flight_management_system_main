{% extends "layout.html" %}
{% load static %}

{% block content %}
<h1 class="mb-4">Book Flight</h1>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Flight Details</h5>
        <p><strong>Flight Number:</strong> {{ flight.flight_number }}</p>
        <p><strong>From:</strong> {{ flight.origin.city }} ({{ flight.origin.code }}) <strong>To:</strong> {{ flight.destination.city }} ({{ flight.destination.code }})</p>
        <p><strong>Departure:</strong> {{ flight.departure_time|date:"F d, Y H:i" }}</p>
        <p><strong>Arrival:</strong> {{ flight.arrival_time|date:"F d, Y H:i" }}</p>
        <p><strong>Duration:</strong> {{ flight.duration }}</p>
    </div>
</div>

{% if return_flight %}
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Return Flight Details</h5>
        <p><strong>Flight Number:</strong> {{ return_flight.flight_number }}</p>
        <p><strong>From:</strong> {{ return_flight.origin.city }} ({{ return_flight.origin.code }}) <strong>To:</strong> {{ return_flight.destination.city }} ({{ return_flight.destination.code }})</p>
        <p><strong>Departure:</strong> {{ return_flight.departure_time|date:"F d, Y H:i" }}</p>
        <p><strong>Arrival:</strong> {{ return_flight.arrival_time|date:"F d, Y H:i" }}</p>
        <p><strong>Duration:</strong> {{ return_flight.duration }}</p>
    </div>
</div>
{% endif %}

<form id="bookingForm" method="post" class="needs-validation" novalidate>
    {% csrf_token %}
    {{ booking_form.as_p }}

    <div id="passengerForms">
        <h3>Passenger Information</h3>
        {{ passenger_formset.management_form }}

        <h4>Adults <button type="button" class="btn btn-sm btn-primary add-passenger" data-passenger-type="adult" data-max="{{ adults }}">+</button></h4>
        <div id="adultForms"></div>

        <h4>Children <button type="button" class="btn btn-sm btn-primary add-passenger" data-passenger-type="child" data-max="{{ children }}">+</button></h4>
        <div id="childForms"></div>

        <h4>Infants <button type="button" class="btn btn-sm btn-primary add-passenger" data-passenger-type="infant" data-max="{{ infants }}">+</button></h4>
        <div id="infantForms"></div>
    </div>

    <div class="card mt-4 mb-4">
        <div class="card-body">
            <h5 class="card-title">Booking Summary</h5>
            <p><strong>Total Passengers:</strong> {{ total_passengers }}</p>
            <p><strong>Adults:</strong> <span id="adultCount">0</span>/{{ adults }}</p>
            <p><strong>Children:</strong> <span id="childCount">0</span>/{{ children }}</p>
            <p><strong>Infants:</strong> <span id="infantCount">0</span>/{{ infants }}</p>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Book Flight</button>
</form>

<script type="text/template" id="passenger-form-template">
    <div class="card mb-3 passenger-form" data-index="__prefix__">
        <div class="card-body">
            <h5 class="card-title">__title__ Passenger</h5>
            {% for field in passenger_formset.empty_form %}
                <div class="mb-3">
                    {{ field.label_tag }}
                    {{ field }}
                </div>
            {% endfor %}
        </div>
    </div>
</script>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('bookingForm');
        const addPassengerButtons = document.querySelectorAll('.add-passenger');
        const passengerFormTemplate = document.getElementById('passenger-form-template').innerHTML;
        const totalFormsInput = document.querySelector('#id_passenger-TOTAL_FORMS');
        const counters = {
            'adult': document.getElementById('adultCount'),
            'child': document.getElementById('childCount'),
            'infant': document.getElementById('infantCount')
        };

        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);

        addPassengerButtons.forEach(button => {
            button.addEventListener('click', function() {
                const passengerType = this.dataset.passengerType;
                const max = parseInt(this.dataset.max);
                const currentCount = document.querySelectorAll(`#${passengerType}Forms .passenger-form`).length;

                if (currentCount < max) {
                    const formIndex = parseInt(totalFormsInput.value);
                    const newForm = passengerFormTemplate
                        .replace(/__prefix__/g, formIndex)
                        .replace(/__title__/g, passengerType.charAt(0).toUpperCase() + passengerType.slice(1));

                    document.querySelector(`#${passengerType}Forms`).insertAdjacentHTML('beforeend', newForm);
                    totalFormsInput.value = formIndex + 1;
                    counters[passengerType].textContent = currentCount + 1;

                    if (currentCount + 1 >= max) {
                        this.disabled = true;
                    }
                }
            });
        });
    });
</script>
{% endblock %}