{% extends "layout.html" %}
{% load static %}

{% block content %}
<h1 class="mb-4">Book Flight</h1>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Flight Details</h5>
        <p><strong>Flight Number:</strong> {{ flight.flight_number }}</p>
        <p><strong>From:</strong> {{ flight.origin.city }} ({{ flight.origin.code }}) <strong>To:</strong> {{ flight.destination.city }} ({{ flight.destination.code }})</p>
        <p><strong>Departure:</strong> {{ flight.departure_time|date:"F d, Y H:i" }}</p>
        <p><strong>Arrival:</strong> {{ flight.arrival_time|date:"F d, Y H:i" }}</p>
        <p><strong>Duration:</strong> {{ flight.duration }}</p>
    </div>
</div>

{% if return_flight %}
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Return Flight Details</h5>
        <p><strong>Flight Number:</strong> {{ return_flight.flight_number }}</p>
        <p><strong>From:</strong> {{ return_flight.origin.city }} ({{ return_flight.origin.code }}) <strong>To:</strong> {{ return_flight.destination.city }} ({{ return_flight.destination.code }})</p>
        <p><strong>Departure:</strong> {{ return_flight.departure_time|date:"F d, Y H:i" }}</p>
        <p><strong>Arrival:</strong> {{ return_flight.arrival_time|date:"F d, Y H:i" }}</p>
        <p><strong>Duration:</strong> {{ return_flight.duration }}</p>
    </div>
</div>
{% endif %}

<form id="bookingForm" method="post" class="needs-validation" novalidate>
    {% csrf_token %}

    <div class="mb-4">
        <h3>Ticket Class</h3>
        {{ booking_form.ticket_class.label_tag }}
        {{ booking_form.ticket_class }}
    </div>

    <div id="passengerForms">
        <h3>Passenger Information</h3>

        <div id="adultPassengers">
            <h4>Adult Passengers <button type="button" class="btn btn-sm btn-primary" id="addAdult">+</button></h4>
            <div id="adultForms"></div>
        </div>

        <div id="childPassengers">
            <h4>Child Passengers <button type="button" class="btn btn-sm btn-primary" id="addChild">+</button></h4>
            <div id="childForms"></div>
        </div>

        <div id="infantPassengers">
            <h4>Infant Passengers <button type="button" class="btn btn-sm btn-primary" id="addInfant">+</button></h4>
            <div id="infantForms"></div>
        </div>
    </div>

    <div class="card mt-4 mb-4">
        <div class="card-body">
            <h5 class="card-title">Booking Summary</h5>
            <p><strong>Total Passengers:</strong> <span id="totalPassengers">0</span></p>
            <p><strong>Adults:</strong> <span id="adultCount">0</span></p>
            <p><strong>Children:</strong> <span id="childCount">0</span></p>
            <p><strong>Infants:</strong> <span id="infantCount">0</span></p>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3" id="bookFlightBtn" disabled>Book Flight</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('bookingForm');
        const addAdultBtn = document.getElementById('addAdult');
        const addChildBtn = document.getElementById('addChild');
        const addInfantBtn = document.getElementById('addInfant');
        const adultForms = document.getElementById('adultForms');
        const childForms = document.getElementById('childForms');
        const infantForms = document.getElementById('infantForms');
        const bookFlightBtn = document.getElementById('bookFlightBtn');

        const maxAdults = {{ adults }};
        const maxChildren = {{ children }};
        const maxInfants = {{ infants }};

        let adultCount = 0;
        let childCount = 0;
        let infantCount = 0;

        function updatePassengerCounts() {
            document.getElementById('adultCount').textContent = adultCount;
            document.getElementById('childCount').textContent = childCount;
            document.getElementById('infantCount').textContent = infantCount;
            document.getElementById('totalPassengers').textContent = adultCount + childCount + infantCount;

            bookFlightBtn.disabled = (adultCount !== maxAdults) || (childCount !== maxChildren) || (infantCount !== maxInfants);
        }

        function createPassengerForm(type, index) {
            const div = document.createElement('div');
            div.className = 'card mb-3';
            div.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">${type} Passenger ${index + 1}</h5>
                    <div class="mb-3">
                        <label for="${type}FirstName${index}" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="${type}FirstName${index}" name="${type}FirstName${index}" required>
                    </div>
                    <div class="mb-3">
                        <label for="${type}LastName${index}" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="${type}LastName${index}" name="${type}LastName${index}" required>
                    </div>
                    <div class="mb-3">
                        <label for="${type}MealChoice${index}" class="form-label">Meal Choice</label>
                        <select class="form-control" id="${type}MealChoice${index}" name="${type}MealChoice${index}" required>
                            <option value="">Select Meal</option>
                            <option value="regular">Regular</option>
                            <option value="vegetarian">Vegetarian</option>
                        </select>
                    </div>
                    <input type="hidden" name="${type}PassengerType${index}" value="${type.toLowerCase()}">
                </div>
            `;
            return div;
        }

        addAdultBtn.addEventListener('click', () => {
            if (adultCount < maxAdults) {
                adultForms.appendChild(createPassengerForm('Adult', adultCount));
                adultCount++;
                updatePassengerCounts();
            }
        });

        addChildBtn.addEventListener('click', () => {
            if (childCount < maxChildren) {
                childForms.appendChild(createPassengerForm('Child', childCount));
                childCount++;
                updatePassengerCounts();
            }
        });

        addInfantBtn.addEventListener('click', () => {
            if (infantCount < maxInfants) {
                infantForms.appendChild(createPassengerForm('Infant', infantCount));
                infantCount++;
                updatePassengerCounts();
            }
        });

        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);

        updatePassengerCounts();
    });
</script>
{% endblock %}